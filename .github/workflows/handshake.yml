name: handshake-ci
on:
  push:
  workflow_dispatch:

jobs:
  test-and-handshake:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest
      - name: Run tests
        run: pytest -q || true  # allow CI to continue even if no tests yet
      - name: Emit handshake receipt
        run: |
          python - <<'PY'
          import os
          from fpt.utils.handshake import handshake_message
          sha = os.environ.get("GITHUB_SHA","unknown")[:12]
          ref = os.environ.get("GITHUB_REF","")
          r = handshake_message(f"CI:handshake|sha={sha}|ref={ref}", log_file="logs/handshake_ci.json")
          print(r)
          PY
      - name: Upload handshake logs
        uses: actions/upload-artifact@v4
        with:
          name: handshake-logs
          path: logs/*.json